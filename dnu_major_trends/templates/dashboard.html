{% extends "base.html" %}

{% block title %}Dashboard - DNU Major Trends{% endblock %}
{% block page_title %}Dashboard Phân tích{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-funnel"></i> Bộ lọc
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="majorSelect" class="form-label">Chọn ngành</label>
                                <select class="form-select" id="majorSelect">
                                    <option value="">-- Tất cả ngành --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="compareMajors" class="form-label">So sánh ngành</label>
                                <select class="form-select" id="compareMajors" multiple size="3">
                                </select>
                                <small class="text-muted">Giữ Ctrl để chọn nhiều</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-end gap-2">
                            <button class="btn btn-primary" onclick="loadData()">
                                <i class="bi bi-arrow-clockwise"></i> Làm mới
                            </button>
                            <button class="btn btn-outline-secondary" onclick="compareSelected()">
                                <i class="bi bi-diagram-3"></i> So sánh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon text-primary">
                <i class="bi bi-people"></i>
            </div>
            <div class="stat-content">
                <h3 id="totalStudents" class="mb-0">0</h3>
                <p class="text-muted mb-0">Tổng sinh viên</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon text-success">
                <i class="bi bi-book"></i>
            </div>
            <div class="stat-content">
                <h3 id="totalMajors" class="mb-0">0</h3>
                <p class="text-muted mb-0">Số ngành</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon text-info">
                <i class="bi bi-gender-ambiguous"></i>
            </div>
            <div class="stat-content">
                <h3 id="genderRatio" class="mb-0">--</h3>
                <p class="text-muted mb-0">Tỷ lệ Nam/Nữ</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon text-warning">
                <i class="bi bi-calendar-range"></i>
            </div>
            <div class="stat-content">
                <h3 id="yearRange" class="mb-0">--</h3>
                <p class="text-muted mb-0">Năm dữ liệu</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up"></i> 
                    <span id="trendTitle">Xu hướng theo năm</span>
                </h5>
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="80"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-gender-ambiguous"></i> Phân bổ giới tính</h5>
            </div>
            <div class="card-body">
                <canvas id="genderChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Phân bổ khu vực</h5>
            </div>
            <div class="card-body">
                <canvas id="regionChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Top 10 ngành HOT</h5>
            </div>
            <div class="card-body">
                <canvas id="topMajorsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Heatmap -->
<div class="row g-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-grid-3x3"></i> Bản đồ nhiệt - Mức độ phổ biến theo năm</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive" id="heatmapContainer">
                    <p class="text-center text-muted">Đang tải dữ liệu...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let trendChart, genderChart, regionChart, topMajorsChart;
let allMajors = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadMajors();
    loadData();
});

// Load majors list
async function loadMajors() {
    try {
        const response = await fetch('/api/majors');
        const data = await response.json();
        allMajors = data.majors || [];
        
        const select = document.getElementById('majorSelect');
        const compare = document.getElementById('compareMajors');
        
        allMajors.forEach(major => {
            select.innerHTML += `<option value="${major}">${major}</option>`;
            compare.innerHTML += `<option value="${major}">${major}</option>`;
        });
        
        // Add change listener
        select.addEventListener('change', function() {
            if (this.value) {
                loadMajorData(this.value);
            } else {
                loadData();
            }
        });
    } catch (error) {
        console.error('Error loading majors:', error);
    }
}

// Load overview data
async function loadData() {
    try {
        const [overview, gender, region, heatmap] = await Promise.all([
            fetch('/api/overview').then(r => r.json()),
            fetch('/api/gender').then(r => r.json()),
            fetch('/api/region').then(r => r.json()),
            fetch('/api/heatmap').then(r => r.json())
        ]);
        
        // Update stats
        document.getElementById('totalStudents').textContent = 
            overview.total_students.toLocaleString('vi-VN');
        document.getElementById('totalMajors').textContent = overview.total_majors;
        
        if (overview.years && overview.years.length > 0) {
            const minYear = Math.min(...overview.years);
            const maxYear = Math.max(...overview.years);
            document.getElementById('yearRange').textContent = 
                minYear === maxYear ? minYear : `${minYear}-${maxYear}`;
        }
        
        // Gender ratio
        const total = gender.male + gender.female;
        if (total > 0) {
            const ratio = (gender.male / gender.female).toFixed(2);
            document.getElementById('genderRatio').textContent = `${ratio}:1`;
        }
        
        // Update trend title
        document.getElementById('trendTitle').textContent = 'Xu hướng tổng quan theo năm';
        
        // Create yearly trend from overview
        const yearlyData = {};
        overview.top_majors.forEach(item => {
            // This is aggregated data, we'll fetch yearly summary
        });
        
        // Load yearly summary for trend chart
        fetch('/api/yearly_summary').then(r => r.json()).then(data => {
            if (data.years && data.years.length > 0) {
                updateTrendChart(data.years.map(y => y.year), 
                                 data.years.map(y => y.total_students),
                                 'Tổng sinh viên');
            }
        });
        
        // Update charts
        updateGenderChart(gender);
        updateRegionChart(region);
        updateTopMajorsChart(overview.top_majors);
        updateHeatmap(heatmap);
        
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

// Load specific major data
async function loadMajorData(major) {
    try {
        const [trend, gender, region] = await Promise.all([
            fetch(`/api/trend?major=${encodeURIComponent(major)}`).then(r => r.json()),
            fetch(`/api/gender?major=${encodeURIComponent(major)}`).then(r => r.json()),
            fetch(`/api/region?major=${encodeURIComponent(major)}`).then(r => r.json())
        ]);
        
        document.getElementById('trendTitle').textContent = `Xu hướng: ${major}`;
        
        const years = trend.series.map(s => s.year);
        const students = trend.series.map(s => s.students);
        
        updateTrendChart(years, students, major);
        updateGenderChart(gender);
        updateRegionChart(region);
        
    } catch (error) {
        console.error('Error loading major data:', error);
    }
}

// Compare selected majors
async function compareSelected() {
    const select = document.getElementById('compareMajors');
    const selected = Array.from(select.selectedOptions).map(opt => opt.value);
    
    if (selected.length === 0) {
        alert('Vui lòng chọn ít nhất một ngành để so sánh');
        return;
    }
    
    const datasets = [];
    const colors = [
        'rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 205, 86)',
        'rgb(75, 192, 192)', 'rgb(153, 102, 255)', 'rgb(255, 159, 64)'
    ];
    
    for (let i = 0; i < selected.length; i++) {
        const trend = await fetch(`/api/trend?major=${encodeURIComponent(selected[i])}`).then(r => r.json());
        datasets.push({
            label: selected[i],
            data: trend.series.map(s => s.students),
            borderColor: colors[i % colors.length],
            backgroundColor: colors[i % colors.length] + '20',
            tension: 0.4
        });
    }
    
    const allYears = [...new Set(datasets.flatMap(d => {
        return datasets[0].data.map((_, idx) => idx);
    }))];
    
    // Get years from first major
    const firstTrend = await fetch(`/api/trend?major=${encodeURIComponent(selected[0])}`).then(r => r.json());
    const years = firstTrend.series.map(s => s.year);
    
    document.getElementById('trendTitle').textContent = `So sánh: ${selected.join(', ')}`;
    
    if (trendChart) trendChart.destroy();
    
    const ctx = document.getElementById('trendChart').getContext('2d');
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: years,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + 
                                   context.parsed.y.toLocaleString('vi-VN') + ' SV';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => value.toLocaleString('vi-VN')
                    }
                }
            }
        }
    });
}

// Chart updates
function updateTrendChart(labels, data, label) {
    if (trendChart) trendChart.destroy();
    
    const ctx = document.getElementById('trendChart').getContext('2d');
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: true },
                tooltip: {
                    callbacks: {
                        label: context => context.parsed.y.toLocaleString('vi-VN') + ' sinh viên'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => value.toLocaleString('vi-VN')
                    }
                }
            }
        }
    });
}

function updateGenderChart(data) {
    if (genderChart) genderChart.destroy();
    
    const ctx = document.getElementById('genderChart').getContext('2d');
    genderChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Nam', 'Nữ'],
            datasets: [{
                data: [data.male, data.female],
                backgroundColor: ['rgb(54, 162, 235)', 'rgb(255, 99, 132)']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: context => {
                            const total = data.male + data.female;
                            const pct = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ' + 
                                   context.parsed.toLocaleString('vi-VN') + 
                                   ` (${pct}%)`;
                        }
                    }
                }
            }
        }
    });
}

function updateRegionChart(data) {
    if (regionChart) regionChart.destroy();
    
    if (!data.series || data.series.length === 0) {
        return;
    }
    
    const ctx = document.getElementById('regionChart').getContext('2d');
    regionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.series.map(s => s.region),
            datasets: [{
                label: 'Sinh viên',
                data: data.series.map(s => s.students),
                backgroundColor: 'rgba(153, 102, 255, 0.6)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: context => context.parsed.y.toLocaleString('vi-VN') + ' sinh viên'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => value.toLocaleString('vi-VN')
                    }
                }
            }
        }
    });
}

function updateTopMajorsChart(data) {
    if (topMajorsChart) topMajorsChart.destroy();
    
    const top10 = data.slice(0, 10);
    
    const ctx = document.getElementById('topMajorsChart').getContext('2d');
    topMajorsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top10.map(m => m.major),
            datasets: [{
                label: 'Sinh viên',
                data: top10.map(m => m.students),
                backgroundColor: 'rgba(255, 159, 64, 0.6)'
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: context => context.parsed.x.toLocaleString('vi-VN') + ' sinh viên'
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => value.toLocaleString('vi-VN')
                    }
                }
            }
        }
    });
}

function updateHeatmap(data) {
    const container = document.getElementById('heatmapContainer');
    
    if (!data.majors || data.majors.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">Chưa có dữ liệu</p>';
        return;
    }
    
    // Create simple HTML table heatmap
    let html = '<table class="table table-bordered table-sm heatmap-table">';
    html += '<thead><tr><th>Ngành</th>';
    data.years.forEach(year => {
        html += `<th>${year}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    // Find max value for color scaling
    const maxVal = Math.max(...data.values.flat());
    
    data.majors.forEach((major, i) => {
        html += `<tr><td class="fw-bold">${major}</td>`;
        data.values[i].forEach(val => {
            const intensity = val / maxVal;
            const color = `rgba(75, 192, 192, ${intensity})`;
            html += `<td style="background-color: ${color}; text-align: center;">${val > 0 ? Math.round(val) : '-'}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}
</script>
{% endblock %}
