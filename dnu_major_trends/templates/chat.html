{% extends "base.html" %}

{% block title %}T∆∞ v·∫•n ng√†nh - DNU Major Trends{% endblock %}
{% block page_title %}Chatbot t∆∞ v·∫•n ng√†nh h·ªçc{% endblock %}

{% block content %}
<div class="row h-100">
    <div class="col-lg-8">
        <div class="card chat-card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex align-items-center">
                    <i class="bi bi-robot fs-4 me-2"></i>
                    <div>
                        <h5 class="mb-0">Tr·ª£ l√Ω t∆∞ v·∫•n ng√†nh h·ªçc AI</h5>
                        <small>H·ªèi t√¥i v·ªÅ s·ªü th√≠ch v√† nƒÉng l·ª±c c·ªßa b·∫°n</small>
                    </div>
                </div>
            </div>
            <div class="card-body chat-body" id="chatMessages">
                <div class="chat-message bot-message">
                    <div class="message-avatar">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="message-content">
                        <p>Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI c·ªßa ƒê·∫°i h·ªçc ƒê·∫°i Nam. üëã</p>
                        <p>H√£y cho t√¥i bi·∫øt:</p>
                        <ul>
                            <li>B·∫°n th√≠ch l√†m g√¨?</li>
                            <li>B·∫°n gi·ªèi m√¥n n√†o?</li>
                            <li>ƒêi·ªÉm trung b√¨nh c·ªßa b·∫°n (n·∫øu c√≥)</li>
                        </ul>
                        <p>T√¥i s·∫Ω g·ª£i √Ω nh·ªØng ng√†nh h·ªçc ph√π h·ª£p nh·∫•t v·ªõi b·∫°n! üéì</p>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white">
                <form id="chatForm" class="d-flex gap-2">
                    <input type="text" class="form-control" id="userInput" 
                           placeholder="Nh·∫≠p s·ªü th√≠ch, ƒëi·ªÉm m·∫°nh c·ªßa b·∫°n..." required>
                    <input type="number" class="form-control" id="scoreInput" 
                           placeholder="ƒêi·ªÉm TB" style="max-width: 100px;" step="0.1" min="0" max="30">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Chat History -->
        <div class="card mb-3">
            <div class="card-header bg-white">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history"></i> L·ªãch s·ª≠ h·ªôi tho·∫°i
                    <button class="btn btn-sm btn-outline-secondary float-end" onclick="loadHistory()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </h6>
            </div>
            <div class="card-body history-list" id="historyList">
                <p class="text-muted text-center">Ch∆∞a c√≥ l·ªãch s·ª≠</p>
            </div>
        </div>

        <!-- Tips -->
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-lightbulb"></i> G·ª£i √Ω c√¢u h·ªèi</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm text-start" 
                            onclick="fillExample('T√¥i th√≠ch l·∫≠p tr√¨nh, l√†m vi·ªác v·ªõi m√°y t√≠nh, gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ logic')">
                        üíª Th√≠ch c√¥ng ngh·ªá
                    </button>
                    <button class="btn btn-outline-success btn-sm text-start" 
                            onclick="fillExample('T√¥i th√≠ch kinh doanh, giao ti·∫øp v·ªõi m·ªçi ng∆∞·ªùi, l√†m vi·ªác nh√≥m')">
                        üíº Th√≠ch kinh doanh
                    </button>
                    <button class="btn btn-outline-info btn-sm text-start" 
                            onclick="fillExample('T√¥i th√≠ch y t·∫ø, chƒÉm s√≥c s·ª©c kh·ªèe, nghi√™n c·ª©u thu·ªëc')">
                        üíä Th√≠ch y d∆∞·ª£c
                    </button>
                    <button class="btn btn-outline-warning btn-sm text-start" 
                            onclick="fillExample('T√¥i th√≠ch ngo·∫°i ng·ªØ, d·ªãch thu·∫≠t, giao ti·∫øp qu·ªëc t·∫ø')">
                        üåê Th√≠ch ng√¥n ng·ªØ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.chat-card {
    height: calc(100vh - 200px);
    display: flex;
    flex-direction: column;
}

.chat-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
}

.chat-message {
    display: flex;
    margin-bottom: 20px;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
}

.bot-message .message-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    margin-right: 12px;
}

.user-message {
    flex-direction: row-reverse;
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    margin-left: 12px;
}

.message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 12px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.user-message .message-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.suggestion-card {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 12px;
    margin: 8px 0;
    border-radius: 4px;
}

.suggestion-card h6 {
    color: #1976d2;
    margin-bottom: 4px;
}

.history-list {
    max-height: 300px;
    overflow-y: auto;
}

.history-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background 0.2s;
}

.history-item:hover {
    background: #f8f9fa;
}

.history-item small {
    display: block;
    color: #6c757d;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadHistory();
    
    document.getElementById('chatForm').addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
});

function fillExample(text) {
    document.getElementById('userInput').value = text;
    document.getElementById('userInput').focus();
}

async function sendMessage() {
    const input = document.getElementById('userInput');
    const scoreInput = document.getElementById('scoreInput');
    const text = input.value.trim();
    const score = scoreInput.value;
    
    if (!text) return;
    
    // Add user message to chat
    addMessage(text, 'user');
    
    // Clear input
    input.value = '';
    
    // Show loading
    const loadingId = addMessage('ƒêang ph√¢n t√≠ch...', 'bot', true);
    
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ text, score })
        });
        
        const data = await response.json();
        
        // Remove loading message
        document.getElementById(loadingId).remove();
        
        // Add bot response
        displaySuggestions(data.suggestions);
        
        // Reload history
        loadHistory();
        
    } catch (error) {
        console.error('Error:', error);
        document.getElementById(loadingId).remove();
        addMessage('Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.', 'bot');
    }
}

function addMessage(text, type, isLoading = false) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageId = 'msg-' + Date.now();
    
    const messageHTML = `
        <div class="chat-message ${type}-message" id="${messageId}">
            <div class="message-avatar">
                <i class="bi bi-${type === 'user' ? 'person' : 'robot'}"></i>
            </div>
            <div class="message-content">
                ${isLoading ? '<div class="spinner-border spinner-border-sm"></div>' : ''}
                <p>${text}</p>
            </div>
        </div>
    `;
    
    messagesDiv.insertAdjacentHTML('beforeend', messageHTML);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    return messageId;
}

function displaySuggestions(suggestions) {
    const messagesDiv = document.getElementById('chatMessages');
    
    let html = '<div class="chat-message bot-message"><div class="message-avatar"><i class="bi bi-robot"></i></div><div class="message-content" style="max-width: 85%;">';
    html += '<p><strong>üéØ D·ª±a tr√™n th√¥ng tin c·ªßa b·∫°n, t√¥i g·ª£i √Ω c√°c ng√†nh sau:</strong></p>';
    
    suggestions.forEach((sugg, idx) => {
        const scorePercent = (sugg.score * 100).toFixed(0);
        const stars = '‚≠ê'.repeat(Math.min(5, Math.ceil(sugg.score * 5)));
        
        html += `
            <div class="suggestion-card">
                <h6>${idx + 1}. ${sugg.major} ${stars}</h6>
                <div class="progress mb-2" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: ${scorePercent}%"></div>
                </div>
                <small><strong>ƒê·ªô ph√π h·ª£p:</strong> ${scorePercent}%</small><br>
                <small><strong>T∆∞∆°ng ƒë·ªìng:</strong> ${(sugg.explain.similarity * 100).toFixed(0)}% | 
                       <strong>ƒêi·ªÉm th∆∞·ªüng:</strong> ${(sugg.explain.rule_bonus * 100).toFixed(0)}%</small>
            </div>
        `;
    });
    
    html += '<p class="mt-2"><small><i class="bi bi-info-circle"></i> B·∫°n c√≥ th·ªÉ xem th√™m th√¥ng tin chi ti·∫øt v·ªÅ c√°c ng√†nh n√†y ·ªü m·ª•c Dashboard v√† D·ª± b√°o.</small></p>';
    html += '</div></div>';
    
    messagesDiv.insertAdjacentHTML('beforeend', html);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

async function loadHistory() {
    try {
        const response = await fetch('/api/chat/history');
        const data = await response.json();
        
        const historyList = document.getElementById('historyList');
        
        if (data.messages.length === 0) {
            historyList.innerHTML = '<p class="text-muted text-center">Ch∆∞a c√≥ l·ªãch s·ª≠</p>';
            return;
        }
        
        historyList.innerHTML = '';
        
        data.messages.forEach(msg => {
            const date = new Date(msg.created_at);
            const dateStr = date.toLocaleString('vi-VN');
            
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <div>${msg.text.substring(0, 50)}${msg.text.length > 50 ? '...' : ''}</div>
                <small><i class="bi bi-clock"></i> ${dateStr}</small>
            `;
            
            item.onclick = function() {
                document.getElementById('userInput').value = msg.text;
                if (msg.score) {
                    document.getElementById('scoreInput').value = msg.score;
                }
            };
            
            historyList.appendChild(item);
        });
        
    } catch (error) {
        console.error('Error loading history:', error);
    }
}
</script>
{% endblock %}
